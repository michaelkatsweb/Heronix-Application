<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.text.Text?>
<?import javafx.scene.chart.*?>

<BorderPane xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.heronix.ui.controller.MasterScheduleOptimizationController"
            stylesheets="@../css/application.css"
            prefWidth="1600" prefHeight="1000">

    <!-- Top: Header -->
    <top>
        <VBox spacing="15" style="-fx-background-color: #9c27b0; -fx-padding: 20;">
            <Label text="Master Schedule Optimization"
                   style="-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: white;"/>
            <Label text="AI-powered schedule optimization with genetic algorithms and constraint satisfaction"
                   style="-fx-font-size: 13px; -fx-text-fill: white;"/>
        </VBox>
    </top>

    <!-- Center: Main Content -->
    <center>
        <SplitPane dividerPositions="0.3, 0.7" style="-fx-background-color: #f5f5f5;">

            <!-- Left: Optimization Configuration -->
            <VBox spacing="15" style="-fx-padding: 15; -fx-background-color: white;">
                <Label text="Optimization Settings" style="-fx-font-size: 18px; -fx-font-weight: bold;"/>

                <!-- Schedule Selection -->
                <VBox spacing="10" style="-fx-background-color: #e3f2fd; -fx-padding: 15; -fx-border-color: #2196f3; -fx-border-width: 2;">
                    <Label text="Schedule to Optimize" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #0d47a1;"/>
                    <ComboBox fx:id="scheduleSelectionComboBox" promptText="Select schedule..." maxWidth="Infinity"/>
                    <Label fx:id="scheduleInfoLabel" text="No schedule selected" wrapText="true" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                </VBox>

                <!-- Optimization Algorithm -->
                <VBox spacing="10" style="-fx-background-color: #fff3e0; -fx-padding: 15; -fx-border-color: #ff9800; -fx-border-width: 2;">
                    <Label text="Algorithm Selection" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #e65100;"/>

                    <Label text="Primary Algorithm:" style="-fx-font-weight: bold; -fx-font-size: 11px;"/>
                    <ComboBox fx:id="algorithmComboBox" promptText="Select algorithm..." maxWidth="Infinity"/>

                    <Label text="Optimization Level:" style="-fx-font-weight: bold; -fx-font-size: 11px;"/>
                    <ComboBox fx:id="optimizationLevelComboBox" maxWidth="Infinity"/>

                    <Label fx:id="algorithmDescriptionLabel" text="" wrapText="true" style="-fx-font-size: 10px; -fx-text-fill: #757575; -fx-padding: 5 0 0 0;"/>
                </VBox>

                <!-- Optimization Objectives -->
                <VBox spacing="10" style="-fx-background-color: #e8f5e9; -fx-padding: 15; -fx-border-color: #4caf50; -fx-border-width: 2;">
                    <Label text="Optimization Objectives" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #2e7d32;"/>

                    <CheckBox fx:id="minimizeConflictsCheckBox" text="Minimize Schedule Conflicts" selected="true"/>
                    <CheckBox fx:id="balanceTeacherWorkloadCheckBox" text="Balance Teacher Workload" selected="true"/>
                    <CheckBox fx:id="maximizeRoomUtilizationCheckBox" text="Maximize Room Utilization" selected="true"/>
                    <CheckBox fx:id="optimizeStudentPathsCheckBox" text="Optimize Student Transition Paths"/>
                    <CheckBox fx:id="minimizeIdleTimeCheckBox" text="Minimize Idle Time"/>
                    <CheckBox fx:id="respectPreferencesCheckBox" text="Respect Teacher Preferences"/>
                    <CheckBox fx:id="balanceClassSizesCheckBox" text="Balance Class Sizes"/>
                </VBox>

                <!-- Constraints -->
                <VBox spacing="10" style="-fx-background-color: #ffebee; -fx-padding: 15; -fx-border-color: #f44336; -fx-border-width: 2;">
                    <Label text="Hard Constraints" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #c62828;"/>

                    <CheckBox fx:id="noTeacherConflictsCheckBox" text="No Teacher Conflicts" selected="true" disable="true"/>
                    <CheckBox fx:id="noRoomConflictsCheckBox" text="No Room Conflicts" selected="true" disable="true"/>
                    <CheckBox fx:id="respectLabRequirementsCheckBox" text="Respect Lab Requirements" selected="true"/>
                    <CheckBox fx:id="respectPrerequisitesCheckBox" text="Respect Prerequisites" selected="true"/>
                    <CheckBox fx:id="respectCapacityLimitsCheckBox" text="Respect Room Capacity" selected="true"/>
                </VBox>

                <!-- Advanced Settings -->
                <VBox spacing="10" style="-fx-background-color: #f3e5f5; -fx-padding: 15; -fx-border-color: #9c27b0; -fx-border-width: 2;">
                    <Label text="Advanced Settings" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #6a1b9a;"/>

                    <Label text="Max Iterations:" style="-fx-font-weight: bold; -fx-font-size: 11px;"/>
                    <Spinner fx:id="maxIterationsSpinner" min="100" max="10000" initialValue="1000" editable="true" maxWidth="Infinity"/>

                    <Label text="Population Size:" style="-fx-font-weight: bold; -fx-font-size: 11px;"/>
                    <Spinner fx:id="populationSizeSpinner" min="50" max="500" initialValue="100" editable="true" maxWidth="Infinity"/>

                    <Label text="Mutation Rate (%):" style="-fx-font-weight: bold; -fx-font-size: 11px;"/>
                    <Slider fx:id="mutationRateSlider" min="1" max="30" value="10" showTickLabels="true" showTickMarks="true" majorTickUnit="10"/>
                    <Label fx:id="mutationRateLabel" text="10%" style="-fx-font-size: 10px; -fx-text-fill: #757575;"/>
                </VBox>

                <!-- Run Button -->
                <Button fx:id="runOptimizationButton" text="⚡ Run Optimization" onAction="#handleRunOptimization"
                        style="-fx-background-color: #9c27b0; -fx-text-fill: white; -fx-font-size: 16px; -fx-font-weight: bold; -fx-padding: 15; -fx-cursor: hand;" maxWidth="Infinity"/>

            </VBox>

            <!-- Center: Results & Visualization -->
            <BorderPane style="-fx-background-color: white;">

                <top>
                    <VBox spacing="15" style="-fx-padding: 20;">
                        <HBox spacing="15" alignment="CENTER_LEFT">
                            <Label text="Optimization Results" style="-fx-font-size: 18px; -fx-font-weight: bold;"/>
                            <Region HBox.hgrow="ALWAYS"/>
                            <Label fx:id="optimizationStatusLabel" text="Ready" style="-fx-font-size: 12px; -fx-text-fill: #757575;"/>
                        </HBox>

                        <!-- Score Comparison Cards -->
                        <GridPane hgap="15" vgap="15">
                            <columnConstraints>
                                <ColumnConstraints percentWidth="33"/>
                                <ColumnConstraints percentWidth="33"/>
                                <ColumnConstraints percentWidth="34"/>
                            </columnConstraints>

                            <!-- Current Score -->
                            <VBox spacing="5" style="-fx-background-color: #ffebee; -fx-padding: 15; -fx-border-color: #f44336; -fx-border-width: 2;"
                                  GridPane.columnIndex="0" GridPane.rowIndex="0">
                                <Label text="Current Schedule" style="-fx-font-size: 11px; -fx-text-fill: #c62828;"/>
                                <Label fx:id="currentScoreLabel" text="--" style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: #c62828;"/>
                                <Label text="Optimization Score" style="-fx-font-size: 10px; -fx-text-fill: #757575;"/>
                            </VBox>

                            <!-- Optimized Score -->
                            <VBox spacing="5" style="-fx-background-color: #e8f5e9; -fx-padding: 15; -fx-border-color: #4caf50; -fx-border-width: 2;"
                                  GridPane.columnIndex="1" GridPane.rowIndex="0">
                                <Label text="Optimized Schedule" style="-fx-font-size: 11px; -fx-text-fill: #2e7d32;"/>
                                <Label fx:id="optimizedScoreLabel" text="--" style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: #2e7d32;"/>
                                <Label text="Optimization Score" style="-fx-font-size: 10px; -fx-text-fill: #757575;"/>
                            </VBox>

                            <!-- Improvement -->
                            <VBox spacing="5" style="-fx-background-color: #e3f2fd; -fx-padding: 15; -fx-border-color: #2196f3; -fx-border-width: 2;"
                                  GridPane.columnIndex="2" GridPane.rowIndex="0">
                                <Label text="Improvement" style="-fx-font-size: 11px; -fx-text-fill: #0d47a1;"/>
                                <Label fx:id="improvementLabel" text="--" style="-fx-font-size: 28px; -fx-font-weight: bold; -fx-text-fill: #0d47a1;"/>
                                <Label text="Percentage" style="-fx-font-size: 10px; -fx-text-fill: #757575;"/>
                            </VBox>
                        </GridPane>

                        <!-- Progress Bar -->
                        <VBox spacing="5">
                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <Label text="Optimization Progress" style="-fx-font-weight: bold; -fx-font-size: 12px;"/>
                                <Label fx:id="iterationLabel" text="0 / 0 iterations" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                            </HBox>
                            <ProgressBar fx:id="optimizationProgressBar" prefWidth="Infinity" progress="0"/>
                        </VBox>
                    </VBox>
                </top>

                <center>
                    <TabPane tabClosingPolicy="UNAVAILABLE" style="-fx-padding: 10;">

                        <!-- Metrics Tab -->
                        <Tab text="Metrics">
                            <ScrollPane fitToWidth="true" fitToHeight="true">
                                <VBox spacing="20" style="-fx-padding: 20;">

                                    <!-- Key Metrics Grid -->
                                    <GridPane hgap="15" vgap="15">
                                        <columnConstraints>
                                            <ColumnConstraints percentWidth="50"/>
                                            <ColumnConstraints percentWidth="50"/>
                                        </columnConstraints>

                                        <!-- Conflicts -->
                                        <VBox spacing="10" style="-fx-background-color: #fafafa; -fx-padding: 15; -fx-border-color: #e0e0e0; -fx-border-width: 1;"
                                              GridPane.columnIndex="0" GridPane.rowIndex="0">
                                            <Label text="Conflicts" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                                            <HBox spacing="20">
                                                <VBox spacing="3">
                                                    <Label text="Before:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="conflictsBeforeLabel" text="0" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #f44336;"/>
                                                </VBox>
                                                <Label text="→" style="-fx-font-size: 20px; -fx-text-fill: #9e9e9e;"/>
                                                <VBox spacing="3">
                                                    <Label text="After:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="conflictsAfterLabel" text="0" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #4caf50;"/>
                                                </VBox>
                                            </HBox>
                                        </VBox>

                                        <!-- Teacher Utilization -->
                                        <VBox spacing="10" style="-fx-background-color: #fafafa; -fx-padding: 15; -fx-border-color: #e0e0e0; -fx-border-width: 1;"
                                              GridPane.columnIndex="1" GridPane.rowIndex="0">
                                            <Label text="Teacher Utilization" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                                            <HBox spacing="20">
                                                <VBox spacing="3">
                                                    <Label text="Before:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="teacherUtilBeforeLabel" text="0%" style="-fx-font-size: 20px; -fx-font-weight: bold;"/>
                                                </VBox>
                                                <Label text="→" style="-fx-font-size: 20px; -fx-text-fill: #9e9e9e;"/>
                                                <VBox spacing="3">
                                                    <Label text="After:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="teacherUtilAfterLabel" text="0%" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #4caf50;"/>
                                                </VBox>
                                            </HBox>
                                        </VBox>

                                        <!-- Room Utilization -->
                                        <VBox spacing="10" style="-fx-background-color: #fafafa; -fx-padding: 15; -fx-border-color: #e0e0e0; -fx-border-width: 1;"
                                              GridPane.columnIndex="0" GridPane.rowIndex="1">
                                            <Label text="Room Utilization" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                                            <HBox spacing="20">
                                                <VBox spacing="3">
                                                    <Label text="Before:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="roomUtilBeforeLabel" text="0%" style="-fx-font-size: 20px; -fx-font-weight: bold;"/>
                                                </VBox>
                                                <Label text="→" style="-fx-font-size: 20px; -fx-text-fill: #9e9e9e;"/>
                                                <VBox spacing="3">
                                                    <Label text="After:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="roomUtilAfterLabel" text="0%" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #4caf50;"/>
                                                </VBox>
                                            </HBox>
                                        </VBox>

                                        <!-- Workload Balance -->
                                        <VBox spacing="10" style="-fx-background-color: #fafafa; -fx-padding: 15; -fx-border-color: #e0e0e0; -fx-border-width: 1;"
                                              GridPane.columnIndex="1" GridPane.rowIndex="1">
                                            <Label text="Workload Balance" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                                            <HBox spacing="20">
                                                <VBox spacing="3">
                                                    <Label text="Before:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="workloadBeforeLabel" text="0%" style="-fx-font-size: 20px; -fx-font-weight: bold;"/>
                                                </VBox>
                                                <Label text="→" style="-fx-font-size: 20px; -fx-text-fill: #9e9e9e;"/>
                                                <VBox spacing="3">
                                                    <Label text="After:" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
                                                    <Label fx:id="workloadAfterLabel" text="0%" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #4caf50;"/>
                                                </VBox>
                                            </HBox>
                                        </VBox>
                                    </GridPane>

                                </VBox>
                            </ScrollPane>
                        </Tab>

                        <!-- Convergence Chart Tab -->
                        <Tab text="Convergence">
                            <VBox style="-fx-padding: 20;">
                                <Label text="Optimization Convergence" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-padding: 0 0 10 0;"/>
                                <LineChart fx:id="convergenceChart" VBox.vgrow="ALWAYS">
                                    <xAxis>
                                        <NumberAxis label="Iteration" side="BOTTOM"/>
                                    </xAxis>
                                    <yAxis>
                                        <NumberAxis label="Fitness Score" side="LEFT"/>
                                    </yAxis>
                                </LineChart>
                            </VBox>
                        </Tab>

                        <!-- Changes Log Tab -->
                        <Tab text="Changes">
                            <VBox spacing="10" style="-fx-padding: 15;">
                                <Label text="Optimization Changes" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                                <TableView fx:id="changesTableView" VBox.vgrow="ALWAYS">
                                    <columns>
                                        <TableColumn fx:id="changeTypeColumn" text="Type" prefWidth="120"/>
                                        <TableColumn fx:id="changeDescriptionColumn" text="Description" prefWidth="400"/>
                                        <TableColumn fx:id="changeReasonColumn" text="Reason" prefWidth="250"/>
                                        <TableColumn fx:id="changeImpactColumn" text="Impact" prefWidth="150"/>
                                    </columns>
                                </TableView>
                            </VBox>
                        </Tab>

                        <!-- Comparison Tab -->
                        <Tab text="Comparison">
                            <ScrollPane fitToWidth="true" fitToHeight="true">
                                <VBox spacing="15" style="-fx-padding: 20;">
                                    <Label text="Before vs. After Comparison" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>

                                    <!-- Side-by-side comparison will go here -->
                                    <HBox spacing="20">
                                        <VBox spacing="10" HBox.hgrow="ALWAYS" style="-fx-background-color: #ffebee; -fx-padding: 15; -fx-border-color: #f44336; -fx-border-width: 2;">
                                            <Label text="Current Schedule" style="-fx-font-size: 13px; -fx-font-weight: bold; -fx-text-fill: #c62828;"/>
                                            <TextArea fx:id="currentScheduleSummary" editable="false" wrapText="true" prefHeight="400"/>
                                        </VBox>

                                        <VBox spacing="10" HBox.hgrow="ALWAYS" style="-fx-background-color: #e8f5e9; -fx-padding: 15; -fx-border-color: #4caf50; -fx-border-width: 2;">
                                            <Label text="Optimized Schedule" style="-fx-font-size: 13px; -fx-font-weight: bold; -fx-text-fill: #2e7d32;"/>
                                            <TextArea fx:id="optimizedScheduleSummary" editable="false" wrapText="true" prefHeight="400"/>
                                        </VBox>
                                    </HBox>
                                </VBox>
                            </ScrollPane>
                        </Tab>

                    </TabPane>
                </center>

            </BorderPane>

            <!-- Right: Actions & History -->
            <VBox spacing="15" style="-fx-padding: 15; -fx-background-color: white;">
                <Label text="Actions" style="-fx-font-size: 16px; -fx-font-weight: bold;"/>

                <!-- Accept/Reject -->
                <VBox spacing="10">
                    <Button fx:id="acceptButton" text="✓ Accept Optimized Schedule" onAction="#handleAcceptOptimization"
                            style="-fx-background-color: #4caf50; -fx-text-fill: white; -fx-font-weight: bold; -fx-padding: 12; -fx-cursor: hand;" maxWidth="Infinity" disable="true"/>

                    <Button fx:id="rejectButton" text="✗ Reject Changes" onAction="#handleRejectOptimization"
                            style="-fx-background-color: #f44336; -fx-text-fill: white; -fx-padding: 10; -fx-cursor: hand;" maxWidth="Infinity" disable="true"/>

                    <Button fx:id="saveComparisonButton" text="Save for Later Review" onAction="#handleSaveComparison"
                            style="-fx-background-color: #ff9800; -fx-text-fill: white; -fx-padding: 10; -fx-cursor: hand;" maxWidth="Infinity" disable="true"/>
                </VBox>

                <Separator/>

                <!-- Export Options -->
                <VBox spacing="10">
                    <Label text="Export" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>

                    <Button text="Export Results Report" onAction="#handleExportResults"
                            style="-fx-background-color: #607d8b; -fx-text-fill: white; -fx-padding: 8; -fx-cursor: hand;" maxWidth="Infinity"/>

                    <Button text="Export Comparison" onAction="#handleExportComparison"
                            style="-fx-background-color: #607d8b; -fx-text-fill: white; -fx-padding: 8; -fx-cursor: hand;" maxWidth="Infinity"/>
                </VBox>

                <Separator/>

                <!-- Optimization History -->
                <VBox spacing="10" VBox.vgrow="ALWAYS">
                    <Label text="Recent Optimizations" style="-fx-font-size: 14px; -fx-font-weight: bold;"/>
                    <ListView fx:id="historyListView" VBox.vgrow="ALWAYS" prefHeight="200"/>
                </VBox>

                <Separator/>

                <!-- Info Panel -->
                <VBox spacing="8" style="-fx-background-color: #e3f2fd; -fx-padding: 12; -fx-border-color: #2196f3; -fx-border-width: 1;">
                    <Label text="ℹ Optimization Info" style="-fx-font-weight: bold; -fx-font-size: 12px; -fx-text-fill: #0d47a1;"/>
                    <Label fx:id="executionTimeLabel" text="Execution Time: --" style="-fx-font-size: 10px;"/>
                    <Label fx:id="generationsLabel" text="Generations: --" style="-fx-font-size: 10px;"/>
                    <Label fx:id="finalFitnessLabel" text="Final Fitness: --" style="-fx-font-size: 10px;"/>
                </VBox>

            </VBox>

        </SplitPane>
    </center>

    <!-- Bottom: Status Bar -->
    <bottom>
        <HBox spacing="15" alignment="CENTER_LEFT" style="-fx-background-color: #fafafa; -fx-padding: 10; -fx-border-color: #e0e0e0; -fx-border-width: 1 0 0 0;">
            <Label fx:id="statusLabel" text="Ready to optimize" style="-fx-font-size: 11px;"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="algorithmStatusLabel" text="Algorithm: Not selected" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
            <Separator orientation="VERTICAL"/>
            <Label fx:id="timeRemainingLabel" text="" style="-fx-font-size: 11px; -fx-text-fill: #757575;"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Label fx:id="lastRunLabel" text="Last run: Never" style="-fx-font-size: 10px; -fx-text-fill: #757575;"/>
        </HBox>
    </bottom>

</BorderPane>
