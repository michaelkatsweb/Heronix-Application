package com.heronix.controller;

import com.heronix.model.domain.ReportHistory;
import com.heronix.service.AttendanceReportExportService;
import com.heronix.service.AttendanceReportPdfService;
import com.heronix.service.ReportHistoryService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import java.time.LocalDate;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * Integration Tests for AttendanceReportApiController
 *
 * Tests the REST API endpoints for report generation including:
 * - Daily attendance report endpoints (Excel and PDF)
 * - Student attendance summary endpoints (Excel and PDF)
 * - Chronic absenteeism report endpoint
 * - HTTP response validation
 * - Content-Type and Content-Disposition headers
 *
 * @author Heronix Development Team
 * @version 1.0
 * @since Phase 53 - Testing Infrastructure
 */
@WebMvcTest(AttendanceReportApiController.class)
class AttendanceReportApiControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private AttendanceReportExportService exportService;

    @MockBean
    private AttendanceReportPdfService pdfService;

    @MockBean
    private ReportHistoryService reportHistoryService;

    private static final byte[] SAMPLE_EXCEL_DATA = "Sample Excel Data".getBytes();
    private static final byte[] SAMPLE_PDF_DATA = "Sample PDF Data".getBytes();

    @Test
    void testGenerateDailyAttendanceExcel_Success() throws Exception {
        // Given
        LocalDate reportDate = LocalDate.of(2025, 12, 30);
        when(exportService.exportDailyAttendanceExcel(reportDate)).thenReturn(SAMPLE_EXCEL_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(1L)
            .reportType(ReportHistory.ReportType.DAILY_ATTENDANCE)
            .reportFormat(ReportHistory.ReportFormat.EXCEL)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/daily/excel")
                .param("date", "2025-12-30"))
            .andExpect(status().isOk())
            .andExpect(content().contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"))
            .andExpect(header().string("Content-Disposition", "attachment; filename=\"daily-attendance-2025-12-30.xlsx\""))
            .andExpect(content().bytes(SAMPLE_EXCEL_DATA));
    }

    @Test
    void testGenerateDailyAttendanceExcel_DefaultDate() throws Exception {
        // Given
        LocalDate yesterday = LocalDate.now().minusDays(1);
        when(exportService.exportDailyAttendanceExcel(yesterday)).thenReturn(SAMPLE_EXCEL_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(1L)
            .reportType(ReportHistory.ReportType.DAILY_ATTENDANCE)
            .reportFormat(ReportHistory.ReportFormat.EXCEL)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then - No date parameter provided, should default to yesterday
        mockMvc.perform(get("/api/reports/attendance/daily/excel"))
            .andExpect(status().isOk())
            .andExpect(content().contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"));
    }

    @Test
    void testGenerateDailyAttendancePdf_Success() throws Exception {
        // Given
        LocalDate reportDate = LocalDate.of(2025, 12, 30);
        when(pdfService.exportDailyAttendancePdf(reportDate)).thenReturn(SAMPLE_PDF_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(2L)
            .reportType(ReportHistory.ReportType.DAILY_ATTENDANCE)
            .reportFormat(ReportHistory.ReportFormat.PDF)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/daily/pdf")
                .param("date", "2025-12-30"))
            .andExpect(status().isOk())
            .andExpect(content().contentType(MediaType.APPLICATION_PDF))
            .andExpect(header().string("Content-Disposition", "attachment; filename=\"daily-attendance-2025-12-30.pdf\""))
            .andExpect(content().bytes(SAMPLE_PDF_DATA));
    }

    @Test
    void testGenerateStudentAttendanceSummaryExcel_Success() throws Exception {
        // Given
        LocalDate startDate = LocalDate.of(2025, 12, 1);
        LocalDate endDate = LocalDate.of(2025, 12, 30);
        when(exportService.exportStudentAttendanceSummaryExcel(startDate, endDate)).thenReturn(SAMPLE_EXCEL_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(3L)
            .reportType(ReportHistory.ReportType.STUDENT_SUMMARY)
            .reportFormat(ReportHistory.ReportFormat.EXCEL)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/summary/excel")
                .param("startDate", "2025-12-01")
                .param("endDate", "2025-12-30"))
            .andExpect(status().isOk())
            .andExpect(content().contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"))
            .andExpect(header().string("Content-Disposition", "attachment; filename=\"student-summary-2025-12-01-to-2025-12-30.xlsx\""));
    }

    @Test
    void testGenerateStudentAttendanceSummaryExcel_DefaultDates() throws Exception {
        // Given
        LocalDate startOfMonth = LocalDate.now().withDayOfMonth(1);
        LocalDate today = LocalDate.now();
        when(exportService.exportStudentAttendanceSummaryExcel(startOfMonth, today)).thenReturn(SAMPLE_EXCEL_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(3L)
            .reportType(ReportHistory.ReportType.STUDENT_SUMMARY)
            .reportFormat(ReportHistory.ReportFormat.EXCEL)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then - No date parameters, should default to current month
        mockMvc.perform(get("/api/reports/attendance/summary/excel"))
            .andExpect(status().isOk())
            .andExpect(content().contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"));
    }

    @Test
    void testGenerateStudentAttendanceSummaryPdf_Success() throws Exception {
        // Given
        LocalDate startDate = LocalDate.of(2025, 12, 1);
        LocalDate endDate = LocalDate.of(2025, 12, 30);
        when(pdfService.exportStudentAttendanceSummaryPdf(startDate, endDate)).thenReturn(SAMPLE_PDF_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(4L)
            .reportType(ReportHistory.ReportType.STUDENT_SUMMARY)
            .reportFormat(ReportHistory.ReportFormat.PDF)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/summary/pdf")
                .param("startDate", "2025-12-01")
                .param("endDate", "2025-12-30"))
            .andExpect(status().isOk())
            .andExpect(content().contentType(MediaType.APPLICATION_PDF))
            .andExpect(header().string("Content-Disposition", "attachment; filename=\"student-summary-2025-12-01-to-2025-12-30.pdf\""));
    }

    @Test
    void testGenerateChronicAbsenteeismReport_Success() throws Exception {
        // Given
        LocalDate startDate = LocalDate.of(2025, 12, 1);
        LocalDate endDate = LocalDate.of(2025, 12, 30);
        double threshold = 15.0;
        when(exportService.exportChronicAbsenteeismReport(startDate, endDate, threshold)).thenReturn(SAMPLE_EXCEL_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(5L)
            .reportType(ReportHistory.ReportType.CHRONIC_ABSENTEEISM)
            .reportFormat(ReportHistory.ReportFormat.EXCEL)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/chronic-absenteeism")
                .param("startDate", "2025-12-01")
                .param("endDate", "2025-12-30")
                .param("threshold", "15.0"))
            .andExpect(status().isOk())
            .andExpect(content().contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"))
            .andExpect(header().string("Content-Disposition", "attachment; filename=\"chronic-absenteeism-2025-12-01-to-2025-12-30.xlsx\""));
    }

    @Test
    void testGenerateChronicAbsenteeismReport_DefaultThreshold() throws Exception {
        // Given
        LocalDate startDate = LocalDate.of(2025, 12, 1);
        LocalDate endDate = LocalDate.of(2025, 12, 30);
        double defaultThreshold = 10.0;
        when(exportService.exportChronicAbsenteeismReport(startDate, endDate, defaultThreshold)).thenReturn(SAMPLE_EXCEL_DATA);

        ReportHistory mockHistory = ReportHistory.builder()
            .id(5L)
            .reportType(ReportHistory.ReportType.CHRONIC_ABSENTEEISM)
            .reportFormat(ReportHistory.ReportFormat.EXCEL)
            .build();
        when(reportHistoryService.recordReportGeneration(
            any(), any(), any(), any(), anyLong(), any(), any(), any(), anyBoolean()
        )).thenReturn(mockHistory);

        // When/Then - No threshold parameter, should default to 10.0
        mockMvc.perform(get("/api/reports/attendance/chronic-absenteeism")
                .param("startDate", "2025-12-01")
                .param("endDate", "2025-12-30"))
            .andExpect(status().isOk())
            .andExpect(content().contentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"));
    }

    @Test
    void testGenerateDailyAttendanceExcel_ServiceThrowsException() throws Exception {
        // Given
        LocalDate reportDate = LocalDate.of(2025, 12, 30);
        when(exportService.exportDailyAttendanceExcel(reportDate))
            .thenThrow(new RuntimeException("Database connection error"));

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/daily/excel")
                .param("date", "2025-12-30"))
            .andExpect(status().isInternalServerError());
    }

    @Test
    void testGenerateDailyAttendancePdf_ServiceThrowsIOException() throws Exception {
        // Given
        LocalDate reportDate = LocalDate.of(2025, 12, 30);
        when(pdfService.exportDailyAttendancePdf(reportDate))
            .thenThrow(new java.io.IOException("PDF generation failed"));

        // When/Then
        mockMvc.perform(get("/api/reports/attendance/daily/pdf")
                .param("date", "2025-12-30"))
            .andExpect(status().isInternalServerError());
    }

    @Test
    void testGenerateStudentAttendanceSummaryExcel_InvalidDateFormat() throws Exception {
        // When/Then - Invalid date format should result in bad request
        mockMvc.perform(get("/api/reports/attendance/summary/excel")
                .param("startDate", "invalid-date")
                .param("endDate", "2025-12-30"))
            .andExpect(status().isBadRequest());
    }
}
